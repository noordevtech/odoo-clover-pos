<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Payment Method Form View Extension -->
    <record id="pos_payment_method_view_form_inherit_clover" model="ir.ui.view">
        <field name="name">pos.payment.method.form.inherit.clover</field>
        <field name="model">pos.payment.method</field>
        <field name="inherit_id" ref="point_of_sale.pos_payment_method_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='use_payment_terminal']" position="after">
                <!-- Clover Selection Card - shows when no terminal is selected yet -->
                <div invisible="use_payment_terminal or payment_method_type != 'terminal'">
                    <widget name="clover_payment_provider_card"/>
                </div>
                
                <!-- Clover Configuration Fields - shown after Clover is selected -->
                <field name="clover_device_id" 
                       invisible="use_payment_terminal != 'clover'" 
                       required="use_payment_terminal == 'clover'"
                       placeholder="e.g., C031UQ12345678"/>
                
                <field name="clover_environment" 
                       invisible="use_payment_terminal != 'clover'" 
                       required="use_payment_terminal == 'clover'"/>
                
                <field name="clover_server" 
                       invisible="use_payment_terminal != 'clover'"/>
                
                <field name="clover_merchant_id" 
                       invisible="use_payment_terminal != 'clover'" 
                       required="use_payment_terminal == 'clover'"
                       placeholder="Enter your Merchant ID"/>
                
                <field name="clover_app_id" 
                       invisible="use_payment_terminal != 'clover'" 
                       required="use_payment_terminal == 'clover'"
                       placeholder="Enter your App ID"/>
                
                <field name="clover_app_secret" 
                       invisible="use_payment_terminal != 'clover'" 
                       required="use_payment_terminal == 'clover'"
                       password="True"
                       placeholder="Enter your App Secret"/>
                
                <field name="clover_authorization_url" 
                       invisible="use_payment_terminal != 'clover'"
                       widget="CopyClipboardChar"/>
                
                <field name="clover_redirect_url" 
                       invisible="use_payment_terminal != 'clover'"
                       widget="CopyClipboardChar"/>
                
                <field name="clover_authorization_code" 
                       invisible="use_payment_terminal != 'clover'"
                       password="True"
                       placeholder="Paste the authorization code after OAuth"/>
                
                <field name="clover_access_token" 
                       invisible="use_payment_terminal != 'clover'"
                       password="True"
                       readonly="1"/>
            </xpath>
            
            <xpath expr="//sheet" position="before">
                <header invisible="use_payment_terminal != 'clover'">
                    <button name="action_generate_access_token" 
                            type="object" 
                            string="Generate Access Token" 
                            class="btn-primary"
                            invisible="not clover_authorization_code or clover_access_token"/>
                    <button name="action_fetch_clover_device" 
                            type="object" 
                            string="Fetch Clover Device" 
                            class="btn-secondary"
                            invisible="not clover_access_token"/>
                    <button name="action_revoke_token" 
                            type="object" 
                            string="Revoke" 
                            class="btn-warning"
                            invisible="not clover_access_token"
                            confirm="Are you sure you want to revoke the access token?"/>
                    <button name="action_test_connection" 
                            type="object" 
                            string="Test Connection" 
                            class="btn-info"
                            invisible="not clover_access_token or not clover_device_id"/>
                </header>
            </xpath>
        </field>
    </record>

    <!-- OAuth Success Template -->
    <template id="oauth_success" name="Clover OAuth Success">
        <t t-call="web.frontend_layout">
            <div class="container mt-5">
                <div class="alert alert-success">
                    <h4><i class="fa fa-check-circle"/> Authorization Successful!</h4>
                    <p>Your Clover account has been authorized successfully.</p>
                    <p>Authorization code has been saved. Please go back to Odoo and click <strong>"Generate Access Token"</strong> to complete the setup.</p>
                </div>
                <div class="mt-3">
                    <a href="/web" class="btn btn-primary">Back to Odoo</a>
                </div>
            </div>
        </t>
    </template>

    <!-- OAuth Error Template -->
    <template id="oauth_error" name="Clover OAuth Error">
        <t t-call="web.frontend_layout">
            <div class="container mt-5">
                <div class="alert alert-danger">
                    <h4><i class="fa fa-exclamation-triangle"/> Authorization Failed</h4>
                    <p t-esc="error"/>
                </div>
                <div class="mt-3">
                    <a href="/web" class="btn btn-secondary">Back to Odoo</a>
                </div>
            </div>
        </t>
    </template>
</odoo>
